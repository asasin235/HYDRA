# HYDRA Offline Observability Stack
# Start:  docker compose -f docker/observability/docker-compose.yml up -d
# Stop:   docker compose -f docker/observability/docker-compose.yml down
# Data persisted to external SSD at /Volumes/MacMini-Storage/docker/observability/

version: "3.8"

services:

  # ── Prometheus — time-series metrics scraper ──────────────────────────────
  prometheus:
    image: prom/prometheus:v2.51.0
    container_name: hydra-prometheus
    restart: unless-stopped
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - /Volumes/MacMini-Storage/docker/observability/prometheus-data:/prometheus
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.path=/prometheus"
      - "--storage.tsdb.retention.time=90d"
      - "--web.enable-lifecycle"
      - "--web.enable-remote-write-receiver"
    extra_hosts:
      - "host.docker.internal:host-gateway"

  # ── Grafana — dashboards & alerting ──────────────────────────────────────
  grafana:
    image: grafana/grafana:11.0.0
    container_name: hydra-grafana
    restart: unless-stopped
    depends_on:
      - prometheus
    ports:
      - "3000:3000"
    environment:
      GF_SECURITY_ADMIN_USER: hydra
      GF_SECURITY_ADMIN_PASSWORD: hydra-grafana
      GF_USERS_ALLOW_SIGN_UP: "false"
      GF_SERVER_ROOT_URL: "http://192.168.68.68:3000"
      GF_DASHBOARDS_DEFAULT_HOME_DASHBOARD_PATH: /etc/grafana/provisioning/dashboards/hydra.json
      GF_ANALYTICS_REPORTING_ENABLED: "false"
      GF_ANALYTICS_CHECK_FOR_UPDATES: "false"
    volumes:
      - /Volumes/MacMini-Storage/docker/observability/grafana-data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning:ro

  # ── GlitchTip — self-hosted Sentry for exception tracking ────────────────
  glitchtip-db:
    image: postgres:16-alpine
    container_name: hydra-glitchtip-db
    restart: unless-stopped
    environment:
      POSTGRES_DB: glitchtip
      POSTGRES_USER: glitchtip
      POSTGRES_PASSWORD: glitchtip-local-only
    volumes:
      - /Volumes/MacMini-Storage/docker/observability/glitchtip-db:/var/lib/postgresql/data

  glitchtip-redis:
    image: redis:7-alpine
    container_name: hydra-glitchtip-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - /Volumes/MacMini-Storage/docker/observability/glitchtip-redis:/data

  glitchtip-web:
    image: glitchtip/glitchtip
    container_name: hydra-glitchtip
    restart: unless-stopped
    depends_on:
      - glitchtip-db
      - glitchtip-redis
    ports:
      - "9000:8080"
    environment:
      DATABASE_URL: "postgres://glitchtip:glitchtip-local-only@glitchtip-db:5432/glitchtip"
      REDIS_URL: "redis://glitchtip-redis:6379/0"
      # IMPORTANT: Change SECRET_KEY to a long random string before first run
      # Generate with: openssl rand -hex 32
      SECRET_KEY: "change-me-to-a-long-random-string-before-first-run"
      PORT: "8080"
      GLITCHTIP_DOMAIN: "http://192.168.68.68:9000"
      DEFAULT_FROM_EMAIL: "noreply@hydra.local"
      ENABLE_OPEN_USER_REGISTRATION: "false"
      CELERY_WORKER_AUTOSCALE: "1,3"
    extra_hosts:
      - "host.docker.internal:host-gateway"

  glitchtip-worker:
    image: glitchtip/glitchtip
    container_name: hydra-glitchtip-worker
    restart: unless-stopped
    depends_on:
      - glitchtip-db
      - glitchtip-redis
    command: ./bin/run-celery-with-beat.sh
    environment:
      DATABASE_URL: "postgres://glitchtip:glitchtip-local-only@glitchtip-db:5432/glitchtip"
      REDIS_URL: "redis://glitchtip-redis:6379/0"
      SECRET_KEY: "change-me-to-a-long-random-string-before-first-run"

# ── First-run checklist ──────────────────────────────────────────────────────
# 1. Generate SECRET_KEY:  openssl rand -hex 32
#    Replace both SECRET_KEY values above.
# 2. Create SSD directories:
#    mkdir -p /Volumes/MacMini-Storage/docker/observability/{prometheus-data,grafana-data,glitchtip-db,glitchtip-redis}
# 3. Start stack:
#    docker compose -f docker/observability/docker-compose.yml up -d
# 4. Run GlitchTip DB migrations (first time only):
#    docker exec hydra-glitchtip ./manage.py migrate
#    docker exec hydra-glitchtip ./manage.py createsuperuser
# 5. Open http://192.168.68.68:9000 → create org "HYDRA" → create project "hydra-agents"
#    Copy the DSN and set GLITCHTIP_DSN in .env
# 6. Start pm2-exporter via PM2 (after npm install):
#    pm2 start ecosystem.config.cjs --only pm2-exporter
# 7. Grafana: http://192.168.68.68:3000 (hydra / hydra-grafana)
